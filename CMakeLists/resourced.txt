CMAKE_MINIMUM_REQUIRED (VERSION 2.6)

PROJECT(resource_d)

SET(CMAKE_EXTRA_INCLUDE_FILES unistd.h)

INCLUDE_DIRECTORIES(${RESOURCED_INCLUDEDIR}
  ${RESOURCED_SOURCE_DIR}
  ${MEMORY_SOURCE_DIR}
  ${PROC-STAT_SOURCE_DIR}/include
  ${APP-STAT_SOURCE_DIR}/include
  ${DATAUSAGE_SOURCE_DIR}/include
  ${NETWORK_SOURCE_DIR}/include)

CONFIGURE_FILE(${INCLUDE_COMMON_DIR}/config.h.in
  ${INCLUDE_COMMON_DIR}/config.h)

SET (HEADERS
  ${DATAUSAGE_SOURCE_DIR}/include/daemon-options.h
  ${DATAUSAGE_SOURCE_DIR}/include/datausage-vconf-callbacks.h
  ${INCLUDE_COMMON_DIR}/config.h
  ${INCLUDE_COMMON_DIR}/config-parser.h
  ${INCLUDE_COMMON_DIR}/const.h
  ${INCLUDE_COMMON_DIR}/macro.h
  ${INCLUDE_COMMON_DIR}/lowmem-common.h
  ${INCLUDE_COMMON_DIR}/module-data.h
  ${INCLUDE_COMMON_DIR}/module.h
  ${INCLUDE_COMMON_DIR}/daemon-options.h
  ${INCLUDE_COMMON_DIR}/settings.h
  ${INCLUDE_COMMON_DIR}/transmission.h
  ${COMMON_SOURCE_DIR}/counter.h
  ${INCLUDE_COMMON_DIR}/swap-common.h
  ${INCLUDE_COMMON_DIR}/cpu-common.h
  )

SET (SOURCES
  ${CGROUP_SOURCE_DIR}/cgroup.c
  ${COMMON_SOURCE_DIR}/appid-helper.c
  ${COMMON_SOURCE_DIR}/config-parser.c
  ${COMMON_SOURCE_DIR}/edbus-handler.c
  ${COMMON_SOURCE_DIR}/file-helper.c
  ${COMMON_SOURCE_DIR}/module-data.c
  ${COMMON_SOURCE_DIR}/module.c
  ${DATAUSAGE_SOURCE_DIR}/counter.c
  ${DATAUSAGE_SOURCE_DIR}/daemon-options.c
  ${DATAUSAGE_SOURCE_DIR}/join-local.c
  ${COMMON_SOURCE_DIR}/lowmem-common.c
  ${COMMON_SOURCE_DIR}/swap-common.c
  ${COMMON_SOURCE_DIR}/cpu-common.c
  ${PROC-STAT_SOURCE_DIR}/proc-handler.c
  ${PROC-STAT_SOURCE_DIR}/proc-main.c
  ${PROC-STAT_SOURCE_DIR}/proc-monitor.c
  ${PROC-STAT_SOURCE_DIR}/proc-noti.c
  ${PROC-STAT_SOURCE_DIR}/proc-process.c
  ${PROC-STAT_SOURCE_DIR}/proc-winstate.c
  ${RESOURCED_SOURCE_DIR}/init.c
  ${RESOURCED_SOURCE_DIR}/main.c
  ${RESOURCED_SOURCE_DIR}/settings.c
  )

#datausage module
IF("${DATAUSAGE_MODULE}" STREQUAL "ON")

  SET(REQUIRES_LIST
	capi-telephony-network-info
	network)

  SET(SOURCES ${SOURCES}
    ${DATAUSAGE_SOURCE_DIR}/counter-process.c
    ${DATAUSAGE_SOURCE_DIR}/datausage-quota-processing.c
    ${DATAUSAGE_SOURCE_DIR}/datausage-vconf-callbacks.c
    ${DATAUSAGE_SOURCE_DIR}/specific-trace.c
    ${DATAUSAGE_SOURCE_DIR}/datausage-common.c
    ${NETWORK_SOURCE_DIR}/generic-netlink.c
    ${NETWORK_SOURCE_DIR}/iface-cb.c
    ${NETWORK_SOURCE_DIR}/net-restriction.c
    ${NETWORK_SOURCE_DIR}/restriction-handler.c
    ${NETWORK_SOURCE_DIR}/restriction-helper.c
    ${NETWORK_SOURCE_DIR}/restriction-local.c
    ${NETWORK_SOURCE_DIR}/tethering-restriction.c
    ${NETWORK_SOURCE_DIR}/tethering.c
    )
ENDIF()

#memory module
IF("${MEMORY_MODULE}" STREQUAL "ON")
  SET(SOURCES ${SOURCES}
    ${MEMORY_SOURCE_DIR}/lowmem-dbus.c
    ${MEMORY_SOURCE_DIR}/vmpressure-lowmem-handler.c
    )
ENDIF()

#swap module
IF("${SWAP_MODULE}" STREQUAL "ON")
  SET(SOURCES ${SOURCES}
    ${SWAP_SOURCE_DIR}/swap.c
    )
ENDIF()

IF("${CPU_MODULE}" STREQUAL "ON")
  SET(SOURCES ${SOURCES}
    ${CPU_SOURCE_DIR}/cpu.c
    )
ENDIF()

SET (REQUIRES_LIST ${REQUIRES_LIST}
	ecore
	dlog
	glib-2.0
    sqlite3
	vconf
	vconf-internal-keys
	x11
	ecore-x
	ecore-input
	ecore-file
	evas
	edbus)

INCLUDE(FindPkgConfig)
pkg_check_modules(daemon_pkgs REQUIRED ${REQUIRES_LIST})

FOREACH(flag ${daemon_pkgs_CFLAGS})
        SET(EXTRA_CFLAGS "${EXTRA_CFLAGS} ${flag} -pthread")
ENDFOREACH(flag)

SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${EXTRA_CFLAGS}")

ADD_EXECUTABLE(hashtest ${UTILS_SOURCE_DIR}/hashtest.c)
TARGET_LINK_LIBRARIES(hashtest ${daemon_pkgs_LDFLAGS})

ADD_EXECUTABLE(cgroup-test ${UTILS_SOURCE_DIR}/cgroup-test.c
	${CGROUP_SOURCE_DIR}/cgroup.c
	${COMMON_SOURCE_DIR}/file-helper.c
	${COMMON_SOURCE_DIR}/appid-helper.c
	)
TARGET_LINK_LIBRARIES(cgroup-test ${daemon_pkgs_LDFLAGS} "-L/lib/ -lrt")

ADD_EXECUTABLE (${PROJECT_NAME} ${HEADERS} ${SOURCES})
TARGET_LINK_LIBRARIES(${PROJECT_NAME}
  ${daemon_pkgs_LDFLAGS}
  classid)

IF("${DATAUSAGE_MODULE}" STREQUAL "ON")
  TARGET_LINK_LIBRARIES(${PROJECT_NAME}
    resourced
    app-stat
    storage
    )

  IF("${CMAKE_BUILD_TYPE}" STREQUAL  "DEBUG")
	ADD_EXECUTABLE(test-udp-server ${UTILS_SOURCE_DIR}/udp-server.c ${UTILS_SOURCE_DIR}/udp-common.c)
	ADD_EXECUTABLE(test-udp-client ${UTILS_SOURCE_DIR}/udp-client.c ${UTILS_SOURCE_DIR}/udp-common.c)
  ADD_EXECUTABLE(iface-test ${UTILS_SOURCE_DIR}/iface-test.c)
  TARGET_LINK_LIBRARIES(iface-test net-iface ${daemon_pkgs_LDFLAGS})

  ENDIF()

  INSTALL(FILES ${DATA_DIR}/traffic_db.sql
    DESTINATION /usr/share)
ENDIF()

SET_TARGET_PROPERTIES(${PROJECT_NAME} PROPERTIES SKIP_BUILD_RPATH true)
INSTALL(FILES ${PROJECT_NAME}
  DESTINATION ${CMAKE_INSTALL_PREFIX}/bin RENAME resourced
  PERMISSIONS OWNER_READ OWNER_WRITE OWNER_EXECUTE WORLD_EXECUTE)

IF("${MEMORY_ENG}" STREQUAL "ON")
  INSTALL(FILES ${MEMORY_SOURCE_DIR}/memory_eng.conf
    DESTINATION /etc/resourced RENAME memory.conf)
ELSE()
  INSTALL(FILES ${MEMORY_SOURCE_DIR}/memory_user.conf
    DESTINATION /etc/resourced RENAME memory.conf)
ENDIF()

IF("${CPU_MODULE}" STREQUAL "ON")
  INSTALL(FILES ${CPU_SOURCE_DIR}/cpu.conf
    DESTINATION /etc/resourced RENAME cpu.conf)
ELSE()
  INSTALL(PROGRAMS ${CMAKE_BINARY_DIR}/scripts/resourced-cpucgroup.sh DESTINATION bin)
ENDIF()

INSTALL(FILES ${INCLUDE_PUBLIC_DIR}/resourced.h DESTINATION ${CMAKE_INSTALL_PREFIX}/include/system)

